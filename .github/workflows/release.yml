name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Build binaries
        run: |
          VERSION="${GITHUB_REF_NAME}"
          LDFLAGS="-s -w -X main.version=${VERSION}"
          mkdir dist

          build() {
            local os=$1 arch=$2 arm=$3
            local suffix=""
            [ "$os" = "windows" ] && suffix=".exe"
            local name="bgpipe-${os}-${arch}"
            [ -n "$arm" ] && name="${name}v${arm}"
            local out="dist/${name}${suffix}"

            echo "Building $out ..."
            env CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" GOARM="$arm" \
              go build -ldflags="$LDFLAGS" -trimpath -o "$out" . \
              && echo "  OK $(du -sh $out | cut -f1)" \
              || echo "  SKIP (unsupported)"
          }

          # Linux
          build linux amd64
          build linux arm64
          build linux arm   6
          build linux arm   7
          build linux 386
          build linux mips
          build linux mipsle
          build linux mips64
          build linux mips64le
          build linux ppc64
          build linux ppc64le
          build linux s390x
          build linux riscv64
          build linux loong64

          # macOS
          build darwin amd64
          build darwin arm64

          # Windows
          build windows amd64
          build windows arm64
          build windows 386

          # BSDs
          build freebsd amd64
          build freebsd arm64
          build freebsd arm   7
          build freebsd 386
          build openbsd amd64
          build openbsd arm64
          build openbsd 386
          build netbsd  amd64
          build netbsd  arm64
          build netbsd  arm   7
          build netbsd  386

          ls -lh dist/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
